<!DOCTYPE html>
<html>

<head>
  <title>LiteChat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0">
  <link rel="Shortcut Icon" href=/favicon.ico>
  <meta name="applicable-device" content="pc,mobile">
  <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
  <script src="/javascripts/jquery-1.12.0.min.js"></script>
  <link rel='stylesheet' href='/bootstrap-3.3.7-dist/css/bootstrap.css' />
  <link rel='stylesheet' href='/pnotify/pnotify.custom.min.css' />
  <link rel='stylesheet' href='/stylesheets/font-awesome.min.css' />
  <link rel='stylesheet' href='/stylesheets/chatroom.css' />
</head>

<body>
  <div class="chat-container">
    <div class="userList users-menu">
      <!-- <img  class="openMenuImg" src="images/menu.png" alt="menu" /> -->
      <!-- <div class="exitChatRoom openMenuDiv">åœ¨çº¿äººå‘˜</div> -->
      <div class="menu-header">
        <span>åœ¨çº¿äººå‘˜</span>
      </div>
      <ul class="online_users openMenuUl">
        <li style="text-align: center"><a style="float: none" href='/'><span class="icon-signout"></span> é€€å‡º</a></li>
      </ul>
    </div>
    <div class="chat-content">
      <div class="chat_header" id="header">
        <a data-target="#" class="sidebar-toggle" data-toggle="users-menu" role="button">
          <span class="icon-reorder"></span>
        </a>
        <div class="setting dropdown">
          <a id="dLabel" data-target="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
            <span class="icon-cog"></span>
          </a>
          <ul id="settingMenu" class="dropdown-menu" aria-labelledby="dLabel">
            <li><a id="recive-pv-msg" class="switch-on"><span class="icon-ok"></span> æ¥æ”¶ç§èŠ</a></li>
            <li><a id="show-timestamp" class="switch-on"><span class="icon-ok"></span> æ˜¾ç¤ºæ—¶é—´æˆ³</a></li>
            <li><a id="show-user-dvm" class="switch-on"><span class="icon-ok"></span> ç”¨æˆ·åŠ¨æ€æç¤º</a></li>
            <li><a id="show-ip" class="switch-off"><span class="icon-ok"></span> æ˜¾ç¤ºIP</a></li>
            <li><a id="map-chat-mode" class="switch-off"><span class="icon-ok"></span> åœ°åŸŸèŠå¤©æ¨¡å¼</a></li>
          </ul>
        </div>
        <p>LiteChat</p>
        <div class="online_number">åœ¨çº¿: <span></span>äºº</div>
      </div>
      <div class="chat_window ip-hidden">
      </div>
      <div class="MapChat_window" id="mapChat">
      </div>
      <div class="MapChat_msg">
      </div>
      <div class="input_text">
        <div class="emoji">
          <div class="emoji_package">
            <span>ğŸ˜€</span>
            <span>ğŸ˜‚</span>
            <span>ğŸ˜ƒ</span>
            <span>ğŸ˜„</span>
            <span>ğŸ˜…</span>
            <span>ğŸ˜‰</span>
            <span>ğŸ˜Š</span>
            <span>ğŸ˜‹</span>
            <span>ğŸ˜</span>
            <span>ğŸ˜</span>
            <span>ğŸ˜˜</span>
            <span>ğŸ˜—</span>
            <span>ğŸ˜‘</span>
            <span>ğŸ˜œ</span>
            <span>ğŸ˜’</span>
            <span>ğŸ˜’</span>
            <span>ğŸ˜•</span>
            <span>ğŸ˜¤</span>
            <span>ğŸ˜ </span>
            <span>ğŸ˜‡</span>
            <span>ğŸ˜·</span>
            <span>ğŸ˜¢</span>
            <span>ğŸ˜°</span>
            <span>ğŸ˜¨</span>
            <span>ğŸ˜¦</span>
            <span>ğŸ˜¬</span>
          </div>
        </div>
        <textarea id="message"></textarea>
        <div href="javascript:;" id="sendImg">
          <input type="file" value="Image" accept="image/png,image/gif,image/jpeg" name="file">
          <span class="icon-picture"></span>
        </div>
        <a id="addEmoji" data-target="#" role="button"><img src="/images/emoji.png"></a>
        <button class="btn btn-success" id="sendMsg">å‘é€æ¶ˆæ¯</button>
      </div>
    </div>
  </div>
</body>
<script src="/bootstrap-3.3.7-dist/js/bootstrap.js"></script>
<script src="/javascripts/socket.io.js"></script>
<script src="/pnotify/pnotify.custom.min.js"></script>
<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=YnGapgnXc9tNZ8O2huRxTay3hpGGhyFL"></script>
<script>
// è°ƒæ•´ç•Œé¢å¸ƒå±€
$(window).on("load resize", function(){
  var users_menu_h = $(window).height() - 75;
  var chat_window_h = $(window).height() - $('.chat_header').height() - $('.input_text').height();
  $(".online_users").css("height", users_menu_h);
  $(".chat_window").css("height", chat_window_h);
  $(".MapChat_window").css("height", chat_window_h);
});

// è·å–ç”¨æˆ·æ ‡è¯†
const username = '<%= username %>';
const admin = <%= admin %>;
const ban = <%= ban %>;
// åˆ›å»ºsocketè¿æ¥
var socket = io.connect('http://192.168.0.102:8084/');
var user_list = '';
var online = {
  number: 0,
  users: []
};
var banList = [];
var LastMsgTime = '';
var noticeContent = '';

// å‘æœåŠ¡å™¨æ›´æ–°åœ¨çº¿ç”¨æˆ·
$(function() {
  socket.emit('update', username);
});

// å‘é€ç¾¤èŠæ¶ˆæ¯
var sendMsg = function() {
  var content = $('#message').val();
  if (content != '') {
    var obj = {
      username: username,
      message: content
    };
    // å‘é€æ¶ˆæ¯åˆ°æœåŠ¡ç«¯
    socket.emit('message', obj);
    $('#message').val('');
  }
};

// æ¥å—æ›´æ–°æ¶ˆæ¯
socket.on('message', function(obj, timestamp, type, clientIp) {
  // ç®€åŒ–æ—¶é—´æˆ³
  var timestamp = getTimestamp(timestamp);
  // å®šä¹‰æ­£åˆ™åŒ¹é…è½¬ä¹‰å­—ç¬¦
  var regLt = /\</gi;
  var regEnter = /\n/gi;
  var regSpace = /\s/g;
  //å†å²èŠå¤©å†…å®¹ä¸æ˜¾ç¤ºIP
  if (type == "history") {
    clientIp = '';
  }

  // å°†èŠå¤©å†…å®¹ä¸­çš„éƒ¨åˆ†å­—ç¬¦è¿›è¡Œè½¬ä¹‰
  obj.message = obj.message.replace(regLt, '&lt;').replace(regEnter, "<br>").replace(regSpace, "&nbsp;&nbsp;");
  // æ’å…¥å½“å‰æ—¶é—´
  if (timestamp != LastMsgTime) {
    $('.chat_window').append('<div class="chat_timestamp"><span>' + timestamp + '</span></div>');
    LastMsgTime = timestamp;
  }
  // æ’å…¥èŠå¤©ä¿¡æ¯
  if (obj.username == username) {
    // æœ¬äººä¿¡æ¯æ ·å¼
    $('.chat_window').append("<section class='my_chat'><div class='my_name'>" + obj.username + "</div><span class='my_msg'>" + obj.message + "</span><i class='user-my-ip'>" + clientIp + "</i></section>");
    //åœ°åŸŸèŠå¤©æ¡†
    $('.MapChat_msg').append("<p>[" + timestamp + "] " + obj.username + ": " + obj.message + "</p>");
  } else {
    // ä»–äººä¿¡æ¯æ ·å¼
    $('.chat_window').append("<section class='all_chat'><div class='all_name'>" + obj.username + "</div><span class='all_msg'>" + obj.message + "</span><i class='user-all-ip'>" + clientIp + "</i></section>");
    //åœ°åŸŸèŠå¤©æ¡†
    $('.MapChat_msg').append("<p>[" + timestamp + "] " + obj.username + ": " + obj.message + "</p>");
  }
  // å¦‚æœèŠå¤©ä¿¡æ¯ä¸ºå†å²æ¶ˆæ¯ï¼Œå‘ŠçŸ¥ç”¨æˆ·
  if (type == 'history') {
    // ä½¿æç¤ºä¿¡æ¯ä¿æŒåœ¨å†å²èŠå¤©å†…å®¹çš„åº•ç«¯
    $('.chat_notice').remove();
    $('.chat_newUser').remove();
    $('.chat_window').append('<div class="chat_notice"><span>â€”â€”â€”â€” ä»¥ä¸Šä¸ºæœ€è¿‘èŠå¤©å†…å®¹ â€”â€”â€”â€”</span></div>');
    $('.chat_window').append('<div class="chat_newUser"><span>' + username + 'è¿›å…¥èŠå¤©å®¤</span></div>');
  }
  // èŠå¤©æ¡†æ»šåŠ¨ç½®åº•
  $('.chat_window').scrollTop($('.chat_window').scrollTop() + 9999);
  $('.MapChat_msg').scrollTop($('.chat_window').scrollTop() + 9999);
});

// è·å¾—åœ¨çº¿äººæ•°ä¸åœ¨çº¿åå•
socket.on('update', function(obj, banList, clientIp) {
  var newUser = obj.users[obj.users.length - 1];
  // è‹¥æœ‰æ–°æˆå‘˜åŠ å…¥ä¸”æ­¤äººéç”¨æˆ·æœ¬äºº
  if (online.number < obj.number && newUser != username) {
    // èŠå¤©æ¡†è¾“å…¥è¿›å…¥æç¤º
    $('.chat_window').append('<div class="chat_newUser"><span>' + newUser + ' è¿›å…¥èŠå¤©å®¤</span></div>');
    // tmp code
    socket.emit("new position", username, p.lng, p.lat);
  } else if (online.number > obj.number) {
    for (var i = 0; i < online.number; i++) {
      if (online.users[i] !== obj.users[i]) {
        // èŠå¤©æ¡†è¾“å…¥é€€å‡ºæç¤º
        $('.chat_window').append('<div class="chat_newUser"><span>' + online.users[i] + ' é€€å‡ºèŠå¤©å®¤</span></div>');
        break;
      }
    }
  }
  // èŠå¤©æ¡†æ»šåŠ¨ç½®åº•
  $('.chat_window').scrollTop($('.chat_window').scrollTop() + 9999);

  // å‚æ•°æ›´æ–°
  online.number = obj.number;
  online.users = obj.users;
  // æ›´æ–°åœ¨çº¿äººæ•°
  $('.online_number>span').text(online.number);
  // æ›´æ–°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
  for (var i = 0; i < online.number; i++) {
    // æ„å»ºç”¨æˆ·åˆ—è¡¨
    user_list += '<li><span class="icon-circle"></span> ' + online.users[i];
    // åŠ è½½ä¸å…¶ä»–ç”¨æˆ·çš„äº¤äº’æŒ‰é’®
    if (online.users[i] != username) {
      // åŠ è½½ç®¡ç†å‘˜æƒé™æŒ‰é’®
      if (admin) {
        // åŠ è½½å°ç¦æŒ‰é’®
        user_list += ' <a href="#" name="' + online.users[i] + '" onclick="banUser(this.name, this)"> <span class="icon-ban-circle"></span></a>';
      }
      // åŠ è½½ç§èŠæŒ‰é’®
      user_list += ' <a href="#" name="' + online.users[i] + '" onclick="sendPvMsg(this.name)"> <span class="icon-comment"></span></a>';
    }
    user_list += '</li>';
  }
  // è·å–è¢«å°ç¦ç”¨æˆ·åˆ—è¡¨
  if (admin && banList) {
    for (var i = 0; i < banList.length; i++) {
      // æ„å»ºè¢«ç¦ç”¨æˆ·åˆ—è¡¨
      user_list += '<li class="banList"><span class="icon-circle"></span> ' + banList[i] + ' <a href="#" name="' + banList[i] + '" onclick="freed(this.name)"><span class="icon-reply"></span></a></li>';
    }
  }
  // æ¸…ç©ºæ—§ç”¨æˆ·åˆ—è¡¨
  $('.online_users li:not(:last-child)').remove();
  // é‡æ–°æ’å…¥ç”¨æˆ·åˆ—è¡¨
  $('.online_users').prepend(user_list);
  // æ¸…ç©ºåˆ—è¡¨å‡½æ•°
  user_list = '';
})

// æ¥æ”¶ç§èŠä¿¡æ¯
socket.on('private message', function(obj, timestamp) {
  if ($('#recive-pv-msg').hasClass('switch-on')) {
    // ç®€åŒ–æ—¶é—´æˆ³
    var timestamp = getTimestamp(timestamp);
    // æ˜¾ç¤ºç§èŠå†…å®¹
    showPvMsg(timestamp, obj.from, obj.msg);
  }
})


// ç‚¹å‡»å‘é€æˆ–æŒ‰å›è½¦é”®å‘é€æ¶ˆæ¯
$('button').click(sendMsg);
$('#message').keydown(function(event) {
  if (event.keyCode == 13 && event.ctrlKey) {
    // è‹¥æŒ‰â€œCtrl+å›è½¦â€åˆ™æ¢è¡Œ
    $('#message').val($('#message').val() + "\n");
  } else if (event.keyCode == 13) {
    // è‹¥æŒ‰â€œå›è½¦â€åˆ™å‘é€
    event.preventDefault(); // é˜»æ­¢æŒ‰é’®çš„é»˜è®¤äº¤äº’è¡Œä¸º
    sendMsg();
  }
});

// ç”¨æˆ·åˆ—è¡¨èœå•
$('.userList>img').click(function() {
  if ($(this).hasClass('openMenuImg')) {
    // è‹¥å±•å¼€çŠ¶æ€ï¼Œæ‰§è¡Œå…³é—­
    $(this).removeClass('openMenuImg');
    $('.exitChatRoom').removeClass('openMenuDiv');
    $('.online_users').removeClass('openMenuUl');
  } else {
    // è‹¥å…³é—­çŠ¶æ€ï¼Œæ‰§è¡Œå±•å¼€
    $(this).addClass('openMenuImg');
    $('.exitChatRoom').addClass('openMenuDiv');
    $('.online_users').addClass('openMenuUl');
  }
})

// æ‰“å¼€å…³é—­è¡¨æƒ…æ¡†
$('#addEmoji').click(function(event) {
  // åˆ‡æ¢è¡¨æƒ…æ¡†å±•å¼€å…³é—­
  $('.emoji').toggleClass('emoji_active');
})

// å‘é€è¡¨æƒ…
$('.emoji').click(function(event) {
  if ($(event.target).is('span')) {
    // è¡¨æƒ…æ’å…¥èŠå¤©å†…å®¹
    $('#message').val($('#message').val() + $(event.target).text());
    // åˆ‡æ¢è¡¨æƒ…æ¡†å±•å¼€å…³é—­
    $('.emoji').toggleClass('emoji_active');
  }
})

// å‘é€å›¾ç‰‡
$("#sendImg").on("change", "input[type='file']", function() {
  if (this.files.length != 0) {
    var file = this.files[0],
      reader = new FileReader(); // è½½å…¥æ–‡ä»¶è¯»å–å™¨
    if (!reader) {
      alert("ä¸æ”¯æŒå‘é€å›¾ç‰‡!");
      return;
    };
    reader.onload = function(e) {
      // å°†è‡ªå·±å‘é€çš„å›¾ç‰‡åŠ è½½åˆ°ä¿¡æ¯æ¡†ä¸­
      $('.chat_window').append("<section class='my_chat'><div class='my_name'>" + username + "</div><span class='my_msg'><img src='" + e.target.result + "' /></span></section>");
      // ä¿¡æ¯æ¡†æ»šåŠ¨ç½®åº•
      $('.chat_window').scrollTop($('.chat_window').scrollTop() + 99999);
      // å‘é€å›¾ç‰‡æ•°æ®
      socket.emit('img', { "username": username, "image": e.target.result });
    };
    reader.readAsDataURL(file);
  };
});

// å›¾ç‰‡æ¥æ”¶
socket.on('img', function(obj, timestamp) {
  // ç®€åŒ–æ—¶é—´æˆ³
  var timestamp = getTimestamp(timestamp);
  // æ’å…¥å½“å‰æ—¶é—´
  if (timestamp != LastMsgTime) {
    $('.chat_window').append('<div class="chat_timestamp"><span>' + timestamp + '</span></div>');
    LastMsgTime = timestamp;
  }
  // æ’å…¥å›¾ç‰‡è‡³ä¿¡æ¯æ¡†
  $('.chat_window').append("<section class='all_chat'><div class='all_name'>" + obj.username + "</div><span class='all_msg'><img src='" + obj.image + "' /></span></section>");
  // ä¿¡æ¯æ¡†æ»šåŠ¨ç½®åº•
  $('.chat_window').scrollTop($('.chat_window').scrollTop() + 99999);
});

// æ˜¾ç¤ºå…¬å‘Š
socket.on('show notice', function(timestamp, content) {
  // ç®€åŒ–æ—¶é—´æˆ³
  var timestamp = getTimestamp(timestamp);
  // æ˜¾ç¤ºç§èŠå†…å®¹
  showNotice(timestamp, content);
})

// æ¥æ”¶ç§èŠä¿¡æ¯
socket.on('showNotice', function(timestamp, content) {
  // ç®€åŒ–æ—¶é—´æˆ³
  var timestamp = getTimestamp(timestamp);
  // æ˜¾ç¤ºç§èŠå†…å®¹
  showPvMsg(timestamp, obj.from, obj.msg);
})

// ç”¨æˆ·è¢«å°ç¦
socket.on('ban', function(obj) {
  // alert('å·²è¢«ç®¡ç†å‘˜è¯·ç¦»æˆ¿é—´ï¼');
  // è¿”å›åˆ°ç™»å½•é¡µé¢
  window.location.reload();
});

// å°ç¦æŒ‡ä»¤ç»“æœ
socket.on('ban completed', function(result) {
  showResult(result);
  socket.emit('update', username);
})

// è§£é™¤å°ç¦æŒ‡ä»¤ç»“æœ
socket.on('freed completed', function(result) {
  showResult(result);
  socket.emit('update', username);
})

// ç®¡ç†å‘˜å°ç¦
var banUser = function(name, thisEle) {
  if (admin) {
    socket.emit('ban', name);
    // console.log(thisEle.parentNode);
    // $(thisEle).parent().remove();
  } else {
    alert("æƒé™ä¸è¶³ï¼Œæ“ä½œå¤±è´¥");
  }
}

// ç®¡ç†å‘˜è§£ç¦
var freed = function(name) {
  if (admin) {
    banList = [];
    socket.emit('freed', name);
  } else {
    alert("æƒé™ä¸è¶³ï¼Œæ“ä½œå¤±è´¥");
  }
}

// åŠ è½½ç®¡ç†å‘˜æŒ‰é’®
$(function() {
  if (admin) {
    $('#settingMenu').append('<li class="divider"></li><li><a id="notice" onclick="sendNotice()"><span class="icon-edit"></span> å‘å¸ƒå…¬å‘Š</a></li>');
  }
});

// å‘é€å…¬å‘Š
var sendNotice = function() {
  // å…¬å‘Šå†…å®¹
  new PNotify({
    title: 'å‘å¸ƒå…¬å‘Š',
    text: 'è¾“å…¥å…¬å‘Šå†…å®¹',
    icon: 'glyphicon glyphicon-edit',
    hide: false,
    confirm: {
      prompt: true,
      prompt_multi_line: true,
      prompt_default: noticeContent
    },
    buttons: {
      closer: false,
      sticker: false
    },
    history: {
      history: false
    },
    addclass: 'stack-modal',
    stack: {
      'dir1': 'down',
      'dir2': 'right',
      'modal': true
    },
    mobile: {
      styling: false
    }
  }).get().on('pnotify.confirm', function(e, notice, val) {
    // å‘é€å…¬å‘Šå†…å®¹åˆ°æœåŠ¡ç«¯
    socket.emit('show notice', val);
  });
};

// å‘é€ç§èŠæ¶ˆæ¯
var sendPvMsg = function(name) {
  // ç§ä¿¡æ•°æ®
  var obj = {
    to: name,
    msg: "",
    from: username
  };
  new PNotify({
    title: 'å‘é€ç»™ ' + name,
    text: 'è¾“å…¥è¦å‘é€çš„å†…å®¹ï¼š',
    icon: 'glyphicon glyphicon-edit',
    hide: false,
    confirm: {
      prompt: true
    },
    buttons: {
      closer: false,
      sticker: false
    },
    history: {
      history: false
    },
    addclass: 'stack-modal',
    stack: {
      'dir1': 'down',
      'dir2': 'right',
      'modal': true
    },
    mobile: {
      styling: false
    }
  }).get().on('pnotify.confirm', function(e, notice, val) {
    if (val != "") {
      obj.msg = val;
      // å‘é€æ¶ˆæ¯åˆ°æœåŠ¡ç«¯
      socket.emit('private message', obj);
    }
  });
};

// å…¬å‘Šæ˜¾ç¤º
var showNotice = function(timestamp, content) {
  // ç®€åŒ–æ—¶é—´æˆ³
  var timestamp = getTimestamp(timestamp);
  // è·å–å…¬å‘Šå†…å®¹
  noticeContent = content;
  // PNotify.prototype.options.styling = "bootstrap3";
  var notice = new PNotify({
    title: 'å…¬å‘Š',
    text: noticeContent,
    icon: 'glyphicon glyphicon-exclamation-sign',
    hide: false,
    buttons: {
      closer: false,
      sticker: false
    },
    history: {
      history: false
    },
    addclass: 'stack-modal',
    stack: {
      'dir1': 'down',
      'dir2': 'right',
      'modal': true,
      "overlay_close": true
    },
    mobile: {
      styling: false
    }
  })
  notice.get().click(function() {
    notice.remove();
  });
};

// ç§èŠæç¤º
var showPvMsg = function(timestamp, from, message) {
  // ç®€åŒ–æ—¶é—´æˆ³
  var timestamp = getTimestamp(timestamp);
  // ç§èŠæ¡†å†…å®¹
  // PNotify.prototype.options.styling = "bootstrap3";
  new PNotify({
    title: 'æ¥è‡ª ' + from,
    text: message + '<br><small>' + timestamp + '</small>',
    icon: 'glyphicon glyphicon-comment',
    type: 'info',
    hide: false,
    buttons: {
      sticker: false
    },
    mobile: {
      styling: false
    },
    addclass: 'chat-pnotify'
  });
};

//æ“ä½œç»“æœæç¤º
var showResult = function(result) {
  new PNotify({
    text: result,
    type: 'success',
    buttons: {
      sticker: false
    },
    mobile: {
      styling: false
    },
    addclass: 'stack-modal'
  });
};

// ç®€åŒ–æ—¶é—´æˆ³
var getTimestamp = function(timestamp) {
  // æ—¶é—´æˆ³å–"æ—¶ï¼šåˆ†"
  timestamp = timestamp.substr(0, 5);
  return timestamp;
}

// ä¾§è¾¹æ äº¤äº’
$('.sidebar-toggle').click(function() {
  $('.chat-container').addClass('menu-open');
  event.stopPropagation();
});
$('.chat-content').click(function() {
  $('.chat-container').removeClass('menu-open');
});

// è‡ªå®šä¹‰è®¾ç½®
// â€œæ¥æ”¶ç§èŠâ€è®¾ç½®
$('#recive-pv-msg').click(function() {
  if ($(this).hasClass('switch-on')) {
    $(this).removeClass('switch-on');
    $(this).addClass('switch-off');
  } else if ($(this).hasClass('switch-off')) {
    $(this).removeClass('switch-off');
    $(this).addClass('switch-on');
  }
})
// â€œæ˜¾ç¤ºæ—¶é—´æˆ³â€è®¾ç½®
$('#show-timestamp').click(function() {
  if ($(this).hasClass('switch-on')) {
    $(this).removeClass('switch-on');
    $(this).addClass('switch-off');
    $('.chat_window').addClass("timestamp-hidden");
  } else if ($(this).hasClass('switch-off')) {
    $(this).removeClass('switch-off');
    $(this).addClass('switch-on');
    $('.chat_window').removeClass("timestamp-hidden");
  }
})
// â€œç”¨æˆ·åŠ¨æ€æç¤ºâ€è®¾ç½®
$('#show-user-dvm').click(function() {
  if ($(this).hasClass('switch-on')) {
    $(this).removeClass('switch-on');
    $(this).addClass('switch-off');
    $('.chat_window').addClass("user-dvm-hidden");
  } else if ($(this).hasClass('switch-off')) {
    $(this).removeClass('switch-off');
    $(this).addClass('switch-on');
    $('.chat_window').removeClass("user-dvm-hidden");
  }
})
// â€œæ˜¾ç¤ºIPâ€è®¾ç½®
$('#show-ip').click(function() {
  if ($(this).hasClass('switch-on')) {
    $(this).removeClass('switch-on');
    $(this).addClass('switch-off');
    $('.chat_window').addClass("ip-hidden");
  } else if ($(this).hasClass('switch-off')) {
    $(this).removeClass('switch-off');
    $(this).addClass('switch-on');
    $('.chat_window').removeClass("ip-hidden");
  }
})
// åœ°åŸŸèŠå¤©æ¨¡å¼åˆ‡æ¢
$('#map-chat-mode').click(function() {
  if ($(this).hasClass('switch-on')) {
    $(this).removeClass('switch-on');
    $(this).addClass('switch-off');
    $('.chat-content').removeClass("mapChat-on");
  } else if ($(this).hasClass('switch-off')) {
    $(this).removeClass('switch-off');
    $(this).addClass('switch-on');
    $('.chat-content').addClass("mapChat-on");
  }
})
</script>
<script>
  // åœ°åŸŸèŠå¤©åŠŸèƒ½
  var map = new BMap.Map("mapChat");map.setMapStyle({style:'midnight'});
  var point = new BMap.Point(113.30764968, 23.3200491);
  var p = {
    lng: 0,
    lat: 0
  }
  var marker = [];
  // è®¾ç½®åœ°å›¾ä¸»é¢˜
  map.setMapStyle({style:'midnight'});
  // åœ°å›¾åˆå§‹åŒ–ç„¦ç‚¹å’Œæ”¾å¤§å€æ•°
  map.centerAndZoom(point,12);
  // è·å–å®šä½åæ ‡
  var geolocation = new BMap.Geolocation();
  geolocation.getCurrentPosition(function(r){
    p.lng = r.point.lng;
    p.lat = r.point.lat;
    if(this.getStatus() == BMAP_STATUS_SUCCESS){
      // var mk = new BMap.Marker(r.point);
      // map.addOverlay(mk);
      map.panTo(r.point);
      console.log('å½“å‰ä½ç½®ï¼š'+r.point.lng+','+r.point.lat);
      // å‘é€å®šä½åæ ‡åˆ°æœåŠ¡ç«¯
      socket.emit("new position", username, r.point.lng, r.point.lat);
    }
    else {
      console.log('failed'+this.getStatus());
    }        
  },{enableHighAccuracy: true})
  // å¼€å…³æ§åˆ¶
  map.enableScrollWheelZoom();   //å¯ç”¨æ»šè½®æ”¾å¤§ç¼©å°ï¼Œé»˜è®¤ç¦ç”¨
  map.enableContinuousZoom();    //å¯ç”¨åœ°å›¾æƒ¯æ€§æ‹–æ‹½ï¼Œé»˜è®¤ç¦ç”¨
  // æ ¹æ®æœåŠ¡å™¨è¿”å›ç»“æœï¼Œåœ¨åœ°å›¾ä¸Šæ·»åŠ åæ ‡
  socket.on('add position', function(username, point_lng, point_lat) {
    marker[username] = new BMap.Marker(new BMap.Point(point_lng, point_lat)); // åˆ›å»ºç‚¹
    var label = new BMap.Label(username,{offset:new BMap.Size(20,-10)});
    map.addOverlay(marker[username]);  //å¢åŠ ç‚¹
    marker[username].setLabel(label);
  })
  //åˆ·æ–°åæ ‡
  socket.on('refresh position', function() {
    // æ¸…é™¤æ‰€æœ‰åæ ‡
    map.clearOverlays();
    // é‡æ–°å‘é€å®šä½åæ ‡åˆ°æœåŠ¡ç«¯
    socket.emit("new position", username, p.lng, p.lat);
  })
</script>
</html>